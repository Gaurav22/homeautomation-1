events = require 'events'

class BusEvents extends events.EventEmitter

	constructor: (@messagebus, @topic, @emitparameters = [], options = {}) ->

		options.maxlisteners = 50 if not options.maxlisteners?
		@setMaxListeners options.maxlisteners

		@messagebus.subscribe @topic
		@messagebus.on 'event', @handleEvent

	handleEvent: (topic, event) =>
		return if topic.toString() isnt @topic

		@emit @topic, event
		@emit 'all', event

		for x in @emitparameters
			@emit event[x], event if event[x]?

	send: (event) =>
		event.event ?= @topic
		@messagebus.send event

exports.BusEvents = BusEvents
